@page "/team"
@inherits ProCompontentBase
@inject MasaBlazor MasaBlazor
@inject GlobalConfig GlobalConfig;

<MTabs @bind-Value="_curTab" SliderColor="transparent" class="pro-nav remover-ripple">
    <MTab class="text-capitalize pa-0">
        <ChildContent>
            <span class="mtab-tab-line mtab-tab-linear-primary"></span>
            <span class="rounded-circle mtab-tab-indicator mtab-tab-indicator-primary"></span>
            <span class="mtab-tab-title">Card</span>
        </ChildContent>
    </MTab>
    <MTab class="text-capitalize pa-0" Disabled="_teamDetailDisabled">
        <ChildContent>
            <span class="mtab-tab-line @(_curTab.ToInt32()>0?"mtab-tab-linear-primary":"mtab-tab-linear-neutral")"></span>
            <span class="rounded-circle mtab-tab-indicator @(_curTab.ToInt32()>0?"mtab-tab-indicator-primary":"mtab-tab-indicator-neutral")"></span>
            <span class="mtab-tab-title">Address</span>
        </ChildContent>
    </MTab>
</MTabs>

<MTabsItems Value="_curTab" class="pt-6">
    <MTabItem>
        <div>
            <MRow NoGutters>

                <div class="pr-6" style="width: calc(100% - 300px); display:block;">
                    <div class="rounded-5 pa-6" style="background:#fff;overflow: hidden;">
                        <div class="d-flex mb-6">
                            <MTextField @bind-Value="_projectName" OnKeyDown="SearchProject" Class="rounded-2 mr-6" Height="40" Flat Dense Solo BackgroundColor="fill-lighten-1" HideDetails="@("auto")" Placeholder="请输入项目名称，按回车进行查询">
                                <PrependInnerContent>
                                    <MIcon Size=16 Class="mr-2 neutral-lighten-1--text">mdi-magnify</MIcon>
                                </PrependInnerContent>
                            </MTextField>
                            <MButton Class="rounded-pill" Color="primary" OnClick="()=>ShowProjectModalAsync()"><MIcon Small>mdi-plus </MIcon>添加项目</MButton>
                        </div>
                        <div style="margin:0 -24px; height: calc(100vh - 298px); overflow:auto;">
                            <MExpansionPanels Flat Accordion>
                                @foreach (var project in _projects)
                                {
                                    var apps = _apps.Where(app => app.ProjectId == project.Id).ToList();
                                    <MExpansionPanel Style="margin-bottom: 12px;">
                                        <MExpansionPanelHeader>
                                            <span style="display:flex;align-items:center;margin-right:10px;">
                                                <div class="text-h6" @onclick:stopPropagation @onclick="()=>GetProjectDetailAsync(project.Id,apps.Count)">
                                                    @project.Name
                                                    <span class="ml-2 text-caption">|</span>
                                                    <sapn class="ml-1 text-caption">应用数量:@apps.Count</sapn>
                                                    <div class="text-caption" style="padding:0">@project.Description</div>
                                                </div>
                                                <MSpacer />
                                                <div style="display:flex;align-items:center;">
                                                    <MButton Icon StopPropagation Class="mr-1" OnClick="()=>UpdateProjectAsync(project.Id)"><MIcon>mdi-pencil</MIcon></MButton>
                                                    <MDivider Vertical Style="height: 20px;margin: 7px 8px 0 8px;" />
                                                </div>
                                            </span>
                                        </MExpansionPanelHeader>
                                        <MExpansionPanelContent>
                                            <MRow>
                                                @foreach (var app in apps.Take(3))
                                                {
                                                    <MCol Lg="4" Md="6" Sm="1">
                                                        <AppCard App="app" EnvironmentClusters="app.EnvironmentClusters"></AppCard>
                                                    </MCol>
                                                }
                                            </MRow>
                                            <div class="d-flex justify-space-between mt-3">
                                                <div>
                                                    <img style="height:24px;width:24px" src="/img/avatar/9.svg">
                                                </div>
                                                <div class="text-caption">编辑于一小时前</div>
                                            </div>
                                        </MExpansionPanelContent>
                                    </MExpansionPanel>
                                }

                            </MExpansionPanels>
                        </div>
                    </div>
                </div>

                <MNavigationDrawer Right Permanent Class="rounded-4" Width="300" Style="height: calc(100vh - 186px);">
                    <div class="py-4 px-6" style="min-width:300px; display:flex; flex-direction:column; overflow: auto;">
                        <MAvatar>
                            <MImage Height="48" Width="48" Src="https://cdn.masastack.com/stack/images/website/masa-blazor/jack.png"></MImage>
                        </MAvatar>
                        <MRow NoGutters Class="mt-6">
                            <div class="text-h6">团队名称</div>
                        </MRow>
                        <MRow NoGutters Class="mt-1 text-body2">
                            应用总数：18
                        </MRow>
                        <MRow NoGutters Class="mt-4 text-body2">
                            This is your team's workspace. Invite members to your team to start collaborating. Click here to edit this description.Professional team
                        </MRow>
                        <MRow NoGutters Class="text-caption mt-6">管理员</MRow>
                        <MRow NoGutters Class="mt-4 text-body2">管理员1</MRow>
                        <MRow NoGutters Class="text-caption mt-6">成员</MRow>
                        <MRow NoGutters Class="mt-4 text-body2">成员1</MRow>
                    </div>
                </MNavigationDrawer>

            </MRow>
        </div>
    </MTabItem>
    <MTabItem>
        <div>
            <MRow NoGutters>

                <MNavigationDrawer Right Permanent Class="rounded-4" Width="300" Style="height: calc(100vh - 186px);">
                    <div style="min-width:300px; padding:16px 24px; display:flex; flex-direction:column; align-items:center; overflow: auto; height: calc(100vh - 218px);">
                        <div style="width:100%;" class="text-body2">
                            <MRow NoGutters Align="AlignTypes.Center" Justify="JustifyTypes.SpaceBetween">
                                <div class="text-h6">@_projectDetail.Name</div>
                                <MButton Icon OnClick="()=>UpdateProjectAsync(_selectProjectId)"><MIcon>mdi-pencil</MIcon></MButton>
                            </MRow>
                            <MRow NoGutters Class="mt-6">
                                应用总数：@_appCount
                            </MRow>
                            <MRow NoGutters Class="mt-4">
                                @_projectDetail.Description
                            </MRow>
                            <MRow NoGutters Class="text-caption mt-6">创建人</MRow>
                            <MRow NoGutters Class="mt-4">@_projectDetail.Creator</MRow>
                            <MRow NoGutters Class="text-caption mt-6">参与团队</MRow>
                            <MRow NoGutters Class="mt-4">@_projectDetail.TeamId</MRow>
                            <MRow NoGutters Class="text-caption mt-6">环境/集群</MRow>
                            <div style="display:flex; flex-direction:column;align-items:start">
                                @{
                                    var envCluster = allEnvClusters.Where(envCluster => _projectDetail.EnvironmentClusterIds.Contains(envCluster.Id));
                                    foreach (var item in envCluster)
                                    {
                                        <EnvClusterChip Class="mt-4" EnvironmentName="@item.EnvironmentName" ClusterName="@item.ClusterName" />
                                    }
                                }
                            </div>
                        </div>
                        <MSpacer></MSpacer>
                        <div style="width:100%" class="text-caption d-flex justify-end mt-6">@_projectDetail.CreationTime.ToString("yyyy-MM-dd HH:mm:ss")</div>
                    </div>
                </MNavigationDrawer>

                <div class="pl-6" style="width: calc(100% - 300px); display:block;">
                    <div class="rounded-5 pa-6" style="background:#fff;overflow: hidden;">
                        <div class="d-flex mb-6">
                            <MTextField @bind-Value="_appName" OnKeyDown="SearchApp" Class="rounded-2 mr-6" Height="40" Flat Dense Solo BackgroundColor="fill-lighten-1" HideDetails="@("auto")" Placeholder="请输入应用名称，按回车进行查询">
                                <PrependInnerContent>
                                    <MIcon Size=16 Class="mr-2 neutral-lighten-1--text">mdi-magnify</MIcon>
                                </PrependInnerContent>
                            </MTextField>
                            <MButton Class="rounded-pill" Color="primary" OnClick="()=>ShowAppModal()"><MIcon Small>mdi-plus </MIcon>添加应用</MButton>
                        </div>
                        <div style="margin:0 -24px; height: calc(100vh - 298px); overflow:auto;">
                            <MRow Class="mx-3">
                                @{
                                    foreach (var app in _projectApps)
                                    {
                                        <MCol Lg="4" Md="6" Sm="1">
                                            <AppCard OnClick="()=>UpdateApp(app.Id)" ShowEditInfo EditInfo="@app.CreationTime.ToString()" App="app" EnvironmentClusters="app.EnvironmentClusters"></AppCard>
                                        </MCol>
                                    }
                                }
                            </MRow>
                        </div>
                    </div>
                </div>

            </MRow>
        </div>
    </MTabItem>
</MTabsItems>

<FormModal Visible="_projectFormModel.Visible"
           Title="@(_projectFormModel.HasValue ?"编辑项目":"新增项目")"
           Width="684"
           Model="_projectFormModel.Data"
           OnCancel="ProjectHide">
    <ChildContent>
        <MTextField Outlined Label="项目名称" @bind-Value="_projectFormModel.Data.Name"></MTextField>
        <MAutocomplete @bind-Value="_friends"
                       Items="_people"
                       Chips
                       SmallChips
                       Outlined
                       Color="blue-grey lighten-2"
                       Label="所属项目团队"
                       ItemText="r=>r.Name"
                       ItemValue="r=>r.Name"
                       Multiple>
            <SelectionContent Context="data">
                <MChip Small Close
                       OnCloseClick="()=>Remove(data.Item)">
                    <MAvatar Left>
                        <MImage Src="@data.Item.Avatar"></MImage>
                    </MAvatar>
                    @data.Item.Name
                </MChip>
            </SelectionContent>
            <ItemContent Context="data">
                @if (data.Item is not object)
                {
                    <MListItemContent>@data.Item</MListItemContent>
                }
                else
                {
                    <MListItemAvatar>
                        <img src="@data.Item.Avatar">
                    </MListItemAvatar>
                    <MListItemContent>
                        <MListItemTitle>
                            @((MarkupString)data.Item.Name)
                        </MListItemTitle>
                        <MListItemSubtitle>
                            @((MarkupString)data.Item.Group)
                        </MListItemSubtitle>
                    </MListItemContent>
                }
            </ItemContent>
        </MAutocomplete>
        <MTextField Disabled="@(_projectFormModel.HasValue)" Outlined Label="项目标识" @bind-Value="_projectFormModel.Data.Identity"></MTextField>
        <MSelect @bind-Value="_selectProjectType"
                 Disabled="@(_projectFormModel.HasValue)"
                 Items="Enum<ProjectTypes>.GetEnumObjectList()"
                 ItemText="r=>r.Name"
                 ItemValue="r=>r.Value"
                 Outlined
                 Label="项目类型">
        </MSelect>
        <MAutocomplete @bind-Value="_projectFormModel.Data.EnvironmentClusterIds"
                       Items="allEnvClusters"
                       ItemText="@(r=>$"{r.EnvironmentName} / {r.ClusterName}")"
                       ItemValue="r=>r.Id"
                       Outlined
                       Label="环境/集群"
                       Multiple>
            <SelectionContent Context="_context">
                <EnvClusterChip EnvironmentName="@_context.Item.EnvironmentName" ClusterName="@_context.Item.ClusterName" />
            </SelectionContent>
        </MAutocomplete>
        <MTextarea Outlined Label="项目描述" @bind-Value="_projectFormModel.Data.Description"></MTextarea>
        @if (_projectFormModel.HasValue)
        {
            <MRow Justify="JustifyTypes.SpaceBetween" Style="line-height:normal !important;">
                <MCol Cols=6>创建人: @_projectDetail.Creator</MCol>
                <MCol Class="d-flex justify-end" Cols=6>创建时间: @_projectDetail.CreationTime.ToString("yyyy-MM-dd HH:mm:ss")</MCol>
                <MCol Cols=6>修改人: @_projectDetail.Modifier</MCol>
                <MCol Class="d-flex justify-end" Cols=6>修改时间: @_projectDetail.ModificationTime.ToString("yyyy-MM-dd HH:mm:ss")</MCol>
            </MRow>
        }
    </ChildContent>
    <ActionsContent>
        <div style="width:100%; margin:10px;">
            @if (_projectFormModel.HasValue)
            {
                <MButton OnClick="RemoveProjectAsync" Width=100 Class="rounded-pill" Text Color="red" Style="float:left;">删除</MButton>
            }
            <MButton OnClick="SubmitProjectAsync" Width=100 Class="rounded-pill" Color="primary" Style="float:right;">@(_projectFormModel.HasValue?"保存":"提交")</MButton>
        </div>
    </ActionsContent>
</FormModal>

<FormModal Visible="_appFormModel.Visible"
           Title="@(_appFormModel.HasValue ?"编辑应用":"新增应用")"
           Width="684"
           Model="_appFormModel.Data"
           OnCancel="AppHide">
    <ChildContent>
        <MTextField Outlined Label="应用名称" @bind-Value="_appFormModel.Data.Name"></MTextField>
        <MSelect @bind-Value="_selectAppType"
                 Disabled="@(_appFormModel.HasValue)"
                 Items="Enum<AppTypes>.GetEnumObjectList()"
                 ItemText="r=>r.Name"
                 ItemValue="r=>r.Value"
                 Outlined
                 Label="应用类型">
        </MSelect>
        <FadeTransition>
            <Element Show="@(_selectAppType == (int)AppTypes.Service)" Class="text-center">
                <MSelect @bind-Value="_selectAppServiceType"
                         Disabled="@(_appFormModel.HasValue)"
                         Items="Enum<ServiceTypes>.GetEnumObjectList()"
                         ItemText="r=>r.Name"
                         ItemValue="r=>r.Value"
                         Outlined
                         Label="服务类型">
                </MSelect>
            </Element>
        </FadeTransition>
        <MTextField Outlined Label="Url" @bind-Value="_appFormModel.Data.Url"></MTextField>
        <FadeTransition>
            <Element Show="@(_selectAppType == (int)AppTypes.Service)" Class="text-center">
                <MTextField Outlined Label="Swagger Url" @bind-Value="_appFormModel.Data.SwaggerUrl"></MTextField>
            </Element>
        </FadeTransition>
        <MTextField Disabled="@(_appFormModel.HasValue)" Outlined Label="应用标识" Placeholder="若选择Dapr，应用标识格式建议：app-id，用 - 来划分" @bind-Value="_appFormModel.Data.Identity"></MTextField>
        <MAutocomplete @bind-Value="_appFormModel.Data.EnvironmentClusterIds"
                       Items="_projectEnvClusters"
                       ItemText="@(r=>$"{r.EnvironmentName} / {r.ClusterName}")"
                       ItemValue="r=>r.Id"
                       Outlined
                       Label="环境/集群"
                       Multiple>
            <SelectionContent Context="_context">
                <EnvClusterChip EnvironmentName="@_context.Item.EnvironmentName" ClusterName="@_context.Item.ClusterName" />
            </SelectionContent>
        </MAutocomplete>
        <MTextarea Outlined Label="集群描述" @bind-Value="_appFormModel.Data.Description"></MTextarea>
        @if (_appFormModel.HasValue)
        {
            <MRow Justify="JustifyTypes.SpaceBetween" Style="line-height:normal !important;">
                <MCol Cols=6>创建人: @_appDetail.Creator</MCol>
                <MCol Class="d-flex justify-end" Cols=6>创建时间: @_appDetail.CreationTime.ToString("yyyy-MM-dd HH:mm:ss")</MCol>
                <MCol Cols=6>修改人: @_appDetail.Modifier</MCol>
                <MCol Class="d-flex justify-end" Cols=6>修改时间: @_appDetail.ModificationTime.ToString("yyyy-MM-dd HH:mm:ss")</MCol>
            </MRow>
        }
    </ChildContent>
    <ActionsContent>
        <div style="width:100%; margin:10px;">
            @if (_appFormModel.HasValue)
            {
                <MButton OnClick="RemoveAppAsync" Width=100 Class="rounded-pill" Text Color="red" Style="float:left;">删除</MButton>
            }
            <MButton OnClick="SubmitAppAsync" Width=100 Class="rounded-pill" Color="primary" Style="float:right;">@(_appFormModel.HasValue?"保存":"提交")</MButton>
        </div>
    </ActionsContent>
</FormModal>


@code {
    //team
    private List<string> _friends = new()
        {
            "Sandra Adams",
            "Britta Holt"
        };

    public class Person
    {
        public Guid Id => Guid.NewGuid();

        public string Header { get; set; } = "";

        public string Name { get; set; } = "";

        public string Group { get; set; } = "";

        public string Avatar { get; set; } = "";

        public bool Divider { get; set; }
    }

    private List<Person> _people = new List<Person>
        {
            new Person
            {
                Name="Sandra Adams",
                Group="Group 1",
                Avatar="https://cdn.masastack.com/stack/images/website/masa-blazor/lists/1.png"
            },
            new Person
            {
                Name="Ali Connors",
                Group="Group 1",
                Avatar="https://cdn.masastack.com/stack/images/website/masa-blazor/lists/2.png"
            },
            new Person
            {
                Name="Trevor Hansen",
                Group="Group 1",
                Avatar="https://cdn.masastack.com/stack/images/website/masa-blazor/lists/3.png"
            },
            new Person
            {
                Name="Tucker Smith",
                Group="Group 1",
                Avatar="https://cdn.masastack.com/stack/images/website/masa-blazor/lists/2.png"
            },
            new Person
            {
                Divider=true,
                Name="Group 1"
            }
        };

    public void Remove(Person item)
    {
        var index = _friends.IndexOf(item.Name);
        if (index >= 0)
        {
            _friends.RemoveAt(index);
        }
    }
}
